<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>zen-fs-webdav æµè§ˆå™¨ç¤ºä¾‹</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }
    h1 {
      color: #333;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
    .container {
      display: flex;
      gap: 20px;
    }
    .panel {
      flex: 1;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 15px;
    }
    .file-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #eee;
      border-radius: 4px;
    }
    .file-list li {
      padding: 8px 12px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      display: flex;
      align-items: center;
    }
    .file-list li:hover {
      background-color: #f5f5f5;
    }
    .file-list li:last-child {
      border-bottom: none;
    }
    .file-icon {
      margin-right: 8px;
      font-size: 1.2em;
    }
    .directory {
      color: #2196F3;
    }
    .file {
      color: #607D8B;
    }
    .actions {
      margin-top: 15px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    button {
      padding: 8px 12px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    input[type="text"], textarea {
      width: 100%;
      padding: 8px;
      margin: 5px 0 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    .status {
      margin-top: 15px;
      padding: 10px;
      border-radius: 4px;
    }
    .success {
      background-color: #dff0d8;
      color: #3c763d;
    }
    .error {
      background-color: #f2dede;
      color: #a94442;
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top-color: #4CAF50;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <h1>zen-fs-webdav æµè§ˆå™¨ç¤ºä¾‹</h1>
  
  <div class="panel">
    <h2>WebDAV è¿æ¥è®¾ç½®</h2>
    <div>
      <label for="baseUrl">WebDAV æœåŠ¡å™¨ URL:</label>
      <input type="text" id="baseUrl" placeholder="https://your-webdav-server.com/webdav">
    </div>
    <div>
      <label for="username">ç”¨æˆ·å:</label>
      <input type="text" id="username" placeholder="ç”¨æˆ·å">
    </div>
    <div>
      <label for="password">å¯†ç :</label>
      <input type="password" id="password" placeholder="å¯†ç ">
    </div>
    <div class="actions">
      <button id="connectBtn">è¿æ¥</button>
    </div>
  </div>

  <div class="container">
    <div class="panel">
      <h2>æ–‡ä»¶æµè§ˆå™¨</h2>
      <div>
        <label for="currentPath">å½“å‰è·¯å¾„:</label>
        <input type="text" id="currentPath" value="/" readonly>
      </div>
      <ul class="file-list" id="fileList">
        <li>è¯·å…ˆè¿æ¥åˆ° WebDAV æœåŠ¡å™¨</li>
      </ul>
      <div class="actions">
        <button id="parentDirBtn" disabled>ä¸Šçº§ç›®å½•</button>
        <button id="refreshBtn" disabled>åˆ·æ–°</button>
        <button id="newFolderBtn" disabled>æ–°å»ºæ–‡ä»¶å¤¹</button>
        <button id="uploadFileBtn" disabled>ä¸Šä¼ æ–‡ä»¶</button>
        <input type="file" id="fileInput" class="hidden">
      </div>
    </div>

    <div class="panel">
      <h2>æ–‡ä»¶æ“ä½œ</h2>
      <div>
        <label for="selectedFile">é€‰ä¸­çš„æ–‡ä»¶:</label>
        <input type="text" id="selectedFile" readonly>
      </div>
      <div id="fileContent" class="hidden">
        <label for="fileContentText">æ–‡ä»¶å†…å®¹:</label>
        <textarea id="fileContentText"></textarea>
        <div class="actions">
          <button id="saveFileBtn">ä¿å­˜</button>
        </div>
      </div>
      <div class="actions">
        <button id="downloadBtn" disabled>ä¸‹è½½</button>
        <button id="deleteBtn" disabled>åˆ é™¤</button>
        <button id="renameBtn" disabled>é‡å‘½å</button>
      </div>
    </div>
  </div>

  <div id="statusMessage" class="status hidden"></div>

  <!-- åŠ è½½ zen-fs-webdav åº“ -->
  <script src="../dist/index.umd.js"></script>
  
  <script>
    // è·å– WebDAVFS ç±»
    const { createWebDAVFileSystem } = ZenWebDAVFS;
    
    // DOM å…ƒç´ 
    const baseUrlInput = document.getElementById('baseUrl');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const connectBtn = document.getElementById('connectBtn');
    const currentPathInput = document.getElementById('currentPath');
    const fileList = document.getElementById('fileList');
    const parentDirBtn = document.getElementById('parentDirBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const newFolderBtn = document.getElementById('newFolderBtn');
    const uploadFileBtn = document.getElementById('uploadFileBtn');
    const fileInput = document.getElementById('fileInput');
    const selectedFileInput = document.getElementById('selectedFile');
    const fileContent = document.getElementById('fileContent');
    const fileContentText = document.getElementById('fileContentText');
    const saveFileBtn = document.getElementById('saveFileBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    const renameBtn = document.getElementById('renameBtn');
    const statusMessage = document.getElementById('statusMessage');
    
    // WebDAV å®¢æˆ·ç«¯å®ä¾‹
    let webdavFs = null;
    let currentPath = '/';
    let selectedFile = null;
    
    // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
    function showStatus(message, isError = false) {
      statusMessage.textContent = message;
      statusMessage.className = `status ${isError ? 'error' : 'success'}`;
      statusMessage.classList.remove('hidden');
      
      // 5ç§’åè‡ªåŠ¨éšè—
      setTimeout(() => {
        statusMessage.classList.add('hidden');
      }, 5000);
    }
    
    // æ˜¾ç¤ºåŠ è½½ä¸­çŠ¶æ€
    function showLoading(element) {
      element.disabled = true;
      const originalText = element.textContent;
      const loadingSpinner = document.createElement('span');
      loadingSpinner.className = 'loading';
      element.prepend(loadingSpinner);
      
      return () => {
        element.disabled = false;
        element.removeChild(loadingSpinner);
      };
    }
    
    // è¿æ¥åˆ° WebDAV æœåŠ¡å™¨
    connectBtn.addEventListener('click', async () => {
      const baseUrl = baseUrlInput.value.trim();
      if (!baseUrl) {
        showStatus('è¯·è¾“å…¥ WebDAV æœåŠ¡å™¨ URL', true);
        return;
      }

      const stopLoading = showLoading(connectBtn);

      try {
        const options = {
          baseUrl,
          cache: true,
          cacheExpiration: 30000
        };

        const username = usernameInput.value.trim();
        const password = passwordInput.value;

        if (username && password) {
          options.auth = { username, password };
        }

        webdavFs = createWebDAVFileSystem(options);

        // è§£æ baseUrl è·¯å¾„éƒ¨åˆ†ä½œä¸ºåˆå§‹ currentPath
        let urlObj;
        try {
          urlObj = new URL(baseUrl);
        } catch (e) {
          showStatus('æ— æ•ˆçš„ URL', true);
          stopLoading();
          return;
        }
        let basePath = urlObj.pathname || '/';
        if (!basePath.endsWith('/')) basePath += '/';
        currentPath = basePath;
        currentPathInput.value = currentPath;

        // æµ‹è¯•è¿æ¥
        await webdavFs.exists(currentPath);

        // å¯ç”¨æŒ‰é’®
        parentDirBtn.disabled = false;
        refreshBtn.disabled = false;
        newFolderBtn.disabled = false;
        uploadFileBtn.disabled = false;

        // åŠ è½½æ ¹ç›®å½•
        await loadDirectory(currentPath);

        showStatus('æˆåŠŸè¿æ¥åˆ° WebDAV æœåŠ¡å™¨');
      } catch (error) {
        console.error('è¿æ¥é”™è¯¯:', error);
        showStatus(`è¿æ¥å¤±è´¥: ${error.message}`, true);
      } finally {
        stopLoading();
      }
    });
    
    // åŠ è½½ç›®å½•å†…å®¹
    async function loadDirectory(path) {
      if (!webdavFs) return;
      
      const stopLoading = showLoading(refreshBtn);
      
      try {
        const files = await webdavFs.readDir(path);
        
        // æ¸…ç©ºæ–‡ä»¶åˆ—è¡¨
        fileList.innerHTML = '';
        
        if (files.length === 0) {
          const li = document.createElement('li');
          li.textContent = '(ç©ºç›®å½•)';
          fileList.appendChild(li);
        } else {
          // æŒ‰ç±»å‹å’Œåç§°æ’åºï¼šå…ˆæ˜¾ç¤ºç›®å½•ï¼Œå†æ˜¾ç¤ºæ–‡ä»¶
          files.sort((a, b) => {
            if (a.isDirectory && !b.isDirectory) return -1;
            if (!a.isDirectory && b.isDirectory) return 1;
            return a.name.localeCompare(b.name);
          });
          
          files.forEach(file => {
            const li = document.createElement('li');
            
            const icon = document.createElement('span');
            icon.className = `file-icon ${file.isDirectory ? 'directory' : 'file'}`;
            icon.textContent = file.isDirectory ? 'ğŸ“' : 'ğŸ“„';
            li.appendChild(icon);
            
            const nameSpan = document.createElement('span');
            nameSpan.textContent = file.name;
            li.appendChild(nameSpan);
            
            li.addEventListener('click', () => {
              if (file.isDirectory) {
                // è¿›å…¥ç›®å½•
                currentPath = `${path}/${file.name}`.replace(/\/+/g, '/');
                currentPathInput.value = currentPath;
                loadDirectory(currentPath);
              } else {
                // é€‰æ‹©æ–‡ä»¶
                selectedFile = file;
                selectedFileInput.value = file.name;
                downloadBtn.disabled = false;
                deleteBtn.disabled = false;
                renameBtn.disabled = false;
                
                // å¦‚æœæ˜¯æ–‡æœ¬æ–‡ä»¶ï¼Œå°è¯•åŠ è½½å†…å®¹
                const isTextFile = file.contentType.startsWith('text/') || 
                                  ['.txt', '.md', '.json', '.xml', '.html', '.css', '.js'].some(ext => 
                                    file.name.toLowerCase().endsWith(ext));
                
                if (isTextFile) {
                  loadFileContent(`${path}/${file.name}`.replace(/\/+/g, '/'));
                } else {
                  fileContent.classList.add('hidden');
                }
              }
            });
            
            fileList.appendChild(li);
          });
        }
        
        currentPathInput.value = path;
      } catch (error) {
        console.error('åŠ è½½ç›®å½•é”™è¯¯:', error);
        showStatus(`åŠ è½½ç›®å½•å¤±è´¥: ${error.message}`, true);
      } finally {
        stopLoading();
      }
    }
    
    // åŠ è½½æ–‡ä»¶å†…å®¹
    async function loadFileContent(filePath) {
      const stopLoading = showLoading(downloadBtn);
      
      try {
        const content = await webdavFs.readFile(filePath, { encoding: 'utf8' });
        fileContentText.value = content;
        fileContent.classList.remove('hidden');
      } catch (error) {
        console.error('åŠ è½½æ–‡ä»¶å†…å®¹é”™è¯¯:', error);
        showStatus(`åŠ è½½æ–‡ä»¶å†…å®¹å¤±è´¥: ${error.message}`, true);
        fileContent.classList.add('hidden');
      } finally {
        stopLoading();
      }
    }
    
    // ä¸Šçº§ç›®å½•æŒ‰é’®
    parentDirBtn.addEventListener('click', () => {
      if (currentPath === '/') return;
      
      const parts = currentPath.split('/').filter(Boolean);
      parts.pop();
      currentPath = parts.length === 0 ? '/' : `/${parts.join('/')}`;
      loadDirectory(currentPath);
    });
    
    // åˆ·æ–°æŒ‰é’®
    refreshBtn.addEventListener('click', () => {
      loadDirectory(currentPath);
    });
    
    // æ–°å»ºæ–‡ä»¶å¤¹æŒ‰é’®
    newFolderBtn.addEventListener('click', async () => {
      const folderName = prompt('è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°:');
      if (!folderName) return;
      
      const stopLoading = showLoading(newFolderBtn);
      
      try {
        const folderPath = `${currentPath}/${folderName}`.replace(/\/+/g, '/');
        await webdavFs.mkdir(folderPath);
        showStatus(`æ–‡ä»¶å¤¹ "${folderName}" åˆ›å»ºæˆåŠŸ`);
        loadDirectory(currentPath);
      } catch (error) {
        console.error('åˆ›å»ºæ–‡ä»¶å¤¹é”™è¯¯:', error);
        showStatus(`åˆ›å»ºæ–‡ä»¶å¤¹å¤±è´¥: ${error.message}`, true);
      } finally {
        stopLoading();
      }
    });
    
    // ä¸Šä¼ æ–‡ä»¶æŒ‰é’®
    uploadFileBtn.addEventListener('click', () => {
      fileInput.click();
    });
    
    // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
    fileInput.addEventListener('change', async () => {
      if (!fileInput.files || fileInput.files.length === 0) return;
      
      const file = fileInput.files[0];
      const stopLoading = showLoading(uploadFileBtn);
      
      try {
        const filePath = `${currentPath}/${file.name}`.replace(/\/+/g, '/');
        
        // è¯»å–æ–‡ä»¶å†…å®¹
        const content = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          
          if (file.type.startsWith('text/')) {
            reader.readAsText(file);
          } else {
            reader.readAsArrayBuffer(file);
          }
        });
        
        // ä¸Šä¼ åˆ° WebDAV æœåŠ¡å™¨
        await webdavFs.writeFile(filePath, content);
        showStatus(`æ–‡ä»¶ "${file.name}" ä¸Šä¼ æˆåŠŸ`);
        loadDirectory(currentPath);
        
        // æ¸…é™¤æ–‡ä»¶è¾“å…¥ï¼Œä»¥ä¾¿å¯ä»¥å†æ¬¡ä¸Šä¼ åŒä¸€æ–‡ä»¶
        fileInput.value = '';
      } catch (error) {
        console.error('ä¸Šä¼ æ–‡ä»¶é”™è¯¯:', error);
        showStatus(`ä¸Šä¼ æ–‡ä»¶å¤±è´¥: ${error.message}`, true);
      } finally {
        stopLoading();
      }
    });
    
    // ä¿å­˜æ–‡ä»¶æŒ‰é’®
    saveFileBtn.addEventListener('click', async () => {
      if (!selectedFile) return;
      
      const stopLoading = showLoading(saveFileBtn);
      
      try {
        const filePath = `${currentPath}/${selectedFile.name}`.replace(/\/+/g, '/');
        const content = fileContentText.value;
        
        await webdavFs.writeFile(filePath, content);
        showStatus(`æ–‡ä»¶ "${selectedFile.name}" ä¿å­˜æˆåŠŸ`);
      } catch (error) {
        console.error('ä¿å­˜æ–‡ä»¶é”™è¯¯:', error);
        showStatus(`ä¿å­˜æ–‡ä»¶å¤±è´¥: ${error.message}`, true);
      } finally {
        stopLoading();
      }
    });
    
    // ä¸‹è½½æŒ‰é’®
    downloadBtn.addEventListener('click', async () => {
      if (!selectedFile) return;
      
      const stopLoading = showLoading(downloadBtn);
      
      try {
        const filePath = `${currentPath}/${selectedFile.name}`.replace(/\/+/g, '/');
        let content = await webdavFs.readFile(filePath);
        
        // åˆ›å»ºä¸‹è½½é“¾æ¥
        const blob = new Blob([content], { type: selectedFile.contentType || 'application/octet-stream' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = selectedFile.name;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showStatus(`æ–‡ä»¶ "${selectedFile.name}" ä¸‹è½½æˆåŠŸ`);
      } catch (error) {
        console.error('ä¸‹è½½æ–‡ä»¶é”™è¯¯:', error);
        showStatus(`ä¸‹è½½æ–‡ä»¶å¤±è´¥: ${error.message}`, true);
      } finally {
        stopLoading();
      }
    });
    
    // åˆ é™¤æŒ‰é’®
    deleteBtn.addEventListener('click', async () => {
      if (!selectedFile) return;
      
      if (!confirm(`ç¡®å®šè¦åˆ é™¤ "${selectedFile.name}" å—ï¼Ÿ`)) return;
      
      const stopLoading = showLoading(deleteBtn);
      
      try {
        const filePath = `${currentPath}/${selectedFile.name}`.replace(/\/+/g, '/');
        
        if (selectedFile.isDirectory) {
          await webdavFs.rmdir(filePath, { recursive: true });
        } else {
          await webdavFs.deleteFile(filePath);
        }
        
        showStatus(`${selectedFile.isDirectory ? 'ç›®å½•' : 'æ–‡ä»¶'} "${selectedFile.name}" åˆ é™¤æˆåŠŸ`);
        
        // é‡ç½®é€‰ä¸­çŠ¶æ€
        selectedFile = null;
        selectedFileInput.value = '';
        fileContent.classList.add('hidden');
        downloadBtn.disabled = true;
        deleteBtn.disabled = true;
        renameBtn.disabled = true;
        
        // åˆ·æ–°ç›®å½•
        loadDirectory(currentPath);
      } catch (error) {
        console.error('åˆ é™¤é”™è¯¯:', error);
        showStatus(`åˆ é™¤å¤±è´¥: ${error.message}`, true);
      } finally {
        stopLoading();
      }
    });
    
    // é‡å‘½åæŒ‰é’®
    renameBtn.addEventListener('click', async () => {
      if (!selectedFile) return;
      
      const newName = prompt('è¯·è¾“å…¥æ–°åç§°:', selectedFile.name);
      if (!newName || newName === selectedFile.name) return;
      
      const stopLoading = showLoading(renameBtn);
      
      try {
        const sourcePath = `${currentPath}/${selectedFile.name}`.replace(/\/+/g, '/');
        const destPath = `${currentPath}/${newName}`.replace(/\/+/g, '/');
        
        await webdavFs.move(sourcePath, destPath);
        showStatus(`é‡å‘½åä¸º "${newName}" æˆåŠŸ`);
        
        // é‡ç½®é€‰ä¸­çŠ¶æ€
        selectedFile = null;
        selectedFileInput.value = '';
        fileContent.classList.add('hidden');
        downloadBtn.disabled = true;
        deleteBtn.disabled = true;
        renameBtn.disabled = true;
        
        // åˆ·æ–°ç›®å½•
        loadDirectory(currentPath);
      } catch (error) {
        console.error('é‡å‘½åé”™è¯¯:', error);
        showStatus(`é‡å‘½åå¤±è´¥: ${error.message}`, true);
      } finally {
        stopLoading();
      }
    });
    
    // åˆå§‹åŒ–
    window.addEventListener('load', () => {
      // ä»æœ¬åœ°å­˜å‚¨åŠ è½½ä¸Šæ¬¡çš„è¿æ¥ä¿¡æ¯
      const savedBaseUrl = localStorage.getItem('webdav-baseUrl');
      const savedUsername = localStorage.getItem('webdav-username');
      
      if (savedBaseUrl) {
        baseUrlInput.value = savedBaseUrl;
      }
      
      if (savedUsername) {
        usernameInput.value = savedUsername;
      }
    });
    
    // ä¿å­˜è¿æ¥ä¿¡æ¯åˆ°æœ¬åœ°å­˜å‚¨
    connectBtn.addEventListener('click', () => {
      localStorage.setItem('webdav-baseUrl', baseUrlInput.value);
      localStorage.setItem('webdav-username', usernameInput.value);
      // å‡ºäºå®‰å…¨è€ƒè™‘ï¼Œä¸ä¿å­˜å¯†ç 
    });
  </script>
</body>
</html>